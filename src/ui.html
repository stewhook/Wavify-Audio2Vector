<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Analysis Figma</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- Base and Theme Setup --- */
        body {
            background-color: #1a1a1a;
            color: #e0e0e0;
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            display: grid;
            place-items: center;
            min-height: 100vh;
            margin: 0;
            box-sizing: border-box;
        }

        /* --- Main UI Container --- */
        .ui-container {
            width: 300px;
            height: 600px;
            background-color: #2b2d31;
            border: 1px solid #444;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            padding: 18px 24px;
            box-sizing: border-box;
        }

        /* --- Header --- */
        .ui-header {
            font-size: 1.75rem;
            font-weight: 700;
            color: #ffffff;
            text-align: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        /* --- Form Groups --- */
        .form-group { margin-bottom: 18px; }

        .form-group label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            color: #b0b0b0;
            margin-bottom: 8px;
        }

        .inline-inputs { display: flex; gap: 10px; }
        .input-group-inline { display: flex; flex-direction: column; flex: 1; }
        .input-group-inline label { margin-bottom: 8px; }

        /* --- Number Input Styling --- */
        input[type="number"] {
            width: 100%;
            padding: 8px;
            background-color: #1e1e1e;
            border: 1px solid #555;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 1rem;
            box-sizing: border-box;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        /* --- File Input Styling --- */
        input[type="file"] { font-size: 0.9rem; color: #a0a0a0; }
        input[type="file"]::file-selector-button {
            background-image: linear-gradient(135deg, #4a55c7 0%, #7e5be9 100%);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            margin-right: 12px;
            background-size: 100% 100%;
            box-shadow: 0 3px 10px rgba(74, 85, 199, 0.3);
        }
        input[type="file"]::file-selector-button:hover {
            background-position: 0% 0%;
            box-shadow: 0 4px 15px rgba(126, 91, 233, 0.6);
        }

        /* --- Settings Section (Radios) --- */
        .settings-section { border-top: 1px solid #444; padding-top: 10px; margin-top: auto; }
        .settings-section h3 { font-size: 1.1rem; font-weight: 500; color: #c0c0c0; margin: 0 0 5px; }

        .checkbox-item {
            display: flex; align-items: center; gap: 12px;
            background-color: #3a3a3a; padding: 8px 14px; border-radius: 8px;
            margin-bottom: 6px; cursor: pointer; transition: background-color 0.2s;
        }
        .checkbox-item:hover { background-color: #454545; }
        .checkbox-item input[type="radio"] {
            width: 1.2em; height: 1.2em; accent-color: #4a55c7;
            background-color: #1e1e1e; border-radius: 4px; border: 1px solid #555; cursor: pointer;
        }
        .checkbox-item span { color: #e0e0e0; font-weight: 400; font-size: 1rem; }

        /* --- Analyze Button Styling --- */
        .analyze-button {
            width: 100%; padding: 15px 20px; margin-top: 20px;
            border: none; border-radius: 8px; font-size: 1.2rem; font-weight: 700; color: white; cursor: pointer;
            background-image: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
            background-size: 100% 100%; transition: background-color 0.3s ease-in-out;
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        /* small progress text (optional) */
        .progress { text-align: center; font-size: 0.85rem; color: #bdbdbd; margin-top: 8px; min-height: 1em; }
    </style>
</head>
<body>
    <div class="ui-container">
        <h2 class="ui-header">Vectorize Audio</h2>

        <div class="form-group">
            <label for="file-input">Audio Files</label>
            <!-- ADDED: multiple -->
            <input type="file" id="file-input" name="file-input" accept="audio/*" multiple>
        </div>

        <div class="form-group">
            <label for="packet-input">Packet Count</label>
            <input type="number" id="packet-input" name="packet-input" value="1024" min="1" max="9999">
        </div>

        <div class="form-group">
            <div class="inline-inputs">
                <div class="input-group-inline">
                    <label for="width-input">Width (px)</label>
                    <input type="number" id="width-input" name="dimension-input" placeholder="600" value="600" min="1" max="9999999" title="Width in pixels">
                </div>
                <div class="input-group-inline">
                    <label for="height-input">Height (px)</label>
                    <input type="number" id="height-input" name="dimension-input" placeholder="200" value="200" min="1" max="9999999" title="Height in pixels">
                </div>
            </div>
        </div>

        <div class="settings-section">
            <h3>Settings</h3>

            <label class="checkbox-item">
                <input type="radio" id="setting-default-result" name="option" value="default" checked>
                <span>Default</span>
            </label>

            <label class="checkbox-item">
                <input type="radio" id="setting-group-result" name="option" value="group">
                <span>Group Packets</span>
            </label>

            <label class="checkbox-item">
                <input type="radio" id="setting-union-result" name="option" value="union">
                <span>Union Packets</span>
            </label>
        </div>

        <button class="analyze-button" id="analyze-btn">Analyze</button>
        <div class="progress" id="progress-text"></div>
    </div>

    <script type="module">
        // Elements
        const button = document.getElementById('analyze-btn');
        const fileInput = document.getElementById('file-input');
        const packetInput = document.getElementById('packet-input');
        const widthInput = document.getElementById('width-input');
        const heightInput = document.getElementById('height-input');
        const progressText = document.getElementById('progress-text');
        const options = document.querySelectorAll('input[name="option"]');

        // Helper to read selected option (single value)
        const getSelectedOption = () =>
            (document.querySelector('input[name="option"]:checked')?.value) || 'default';

        // Core analysis for a single File -> posts message to parent
        async function analyzeOneFile(file, { packets, width, height, resultPreference }) {
            console.log(`Analyzing: ${file.name}`);

            const arrayBuffer = await file.arrayBuffer();
            console.log(`Read file buffer length: ${arrayBuffer.byteLength} bytes`);

            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

            const ch0 = audioBuffer.getChannelData(0);
            const samplesPerPacket = Math.max(1, Math.floor(ch0.length / packets));
            const rmsValues = new Array(packets);

            for (let i = 0; i < packets; i++) {
                const start = i * samplesPerPacket;
                const end = Math.min(start + samplesPerPacket, ch0.length);
                let sum = 0;
                for (let j = start; j < end; j++) {
                    const s = ch0[j];
                    sum += s * s;
                }
                const rms = Math.sqrt(sum / Math.max(1, end - start));
                rmsValues[i] = rms;
            }

            // min/max
            let rawMin = Infinity;
            let rawMax = -Infinity;
            for (let i = 0; i < rmsValues.length; i++) {
                const v = rmsValues[i];
                if (v < rawMin) rawMin = v;
                if (v > rawMax) rawMax = v;
            }

            // normalize to [0.05, 1.0]
            const outMin = 0.05;
            const outMax = 1.0;
            const spanOut = outMax - outMin;
            const spanIn = rawMax - rawMin;

            let normalized = [];
            if (spanIn <= 0) {
                normalized = rmsValues.map(() => outMin);
            } else {
                normalized = rmsValues.map(v => {
                    const t = (v - rawMin) / spanIn;
                    const mapped = outMin + t * spanOut;
                    return Math.min(outMax, Math.max(outMin, mapped));
                });
            }

            // Post result for THIS file
            parent.postMessage({
                pluginMessage: {
                    type: 'analysis-ready',
                    data: {
                        audioName: file.name,
                        normalized,
                        minAvg: outMin,
                        maxAvg: outMax,
                        resultPreference,
                        outputWidth: width,
                        outputHeight: height,
                    }
                }
            }, '*');

            console.log('Analysis complete:', { file: file.name, rawMin, rawMax });
        }

        // Button handler: validate once, then process all files sequentially
        button.addEventListener('click', async () => {
            const files = Array.from(fileInput.files || []);
            const width = parseInt(widthInput.value, 10);
            const height = parseInt(heightInput.value, 10);
            const packets = parseInt(packetInput.value, 10);
            const resultPreference = getSelectedOption();

            if (!files.length) {
                alert('Please select at least one audio file.');
                return;
            }
            if (!Number.isFinite(packets) || packets <= 0) {
                alert('Invalid packet amount.');
                return;
            }
            if (!Number.isFinite(width) || width <= 0 || width > 9999999) {
                alert('Invalid width. Must be between 1 and 9999999.');
                return;
            }
            if (!Number.isFinite(height) || height <= 0 || height > 9999999) {
                alert('Invalid height. Must be between 1 and 9999999.');
                return;
            }

            // Lock UI during processing
            button.disabled = true;
            const originalLabel = button.textContent;
            try {
                for (let i = 0; i < files.length; i++) {
                    const f = files[i];
                    button.textContent = `Analyzing (${i + 1}/${files.length})…`;
                    progressText.textContent = `Processing: ${f.name}`;
                    try {
                        await analyzeOneFile(f, { packets, width, height, resultPreference });
                    } catch (err) {
                        console.error(`Error analyzing ${f.name}:`, err);
                        // Continue with next file after alerting
                        alert(`Error analyzing "${f.name}". Skipping to next file.`);
                    }
                }
                progressText.textContent = 'Done.';
            } finally {
                button.disabled = false;
                button.textContent = originalLabel;
                // (optional) keep last filename shown or clear:
                // progressText.textContent = '';
            }
        });
    </script>
</body>
</html>